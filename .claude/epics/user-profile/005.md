---
name: Implement Profile Service
status: open
created: 2026-01-18T08:24:04Z
parallel: true
effort: 3 hours
depends_on: [004]
conflicts_with: []
---

# Task: 005 - Implement Profile Service

## Specification
Create the profile service layer that handles all profile-related API calls to Supabase. This service provides a clean interface for the UI to interact with profile data.

## Acceptance Criteria
- [ ] `profileService.ts` created with all methods
- [ ] `getProfile()` method fetches user profile
- [ ] `updateProfile()` method updates profile data
- [ ] `deleteProfile()` method soft-deletes profile
- [ ] Proper error handling for all methods
- [ ] Type-safe implementation with TypeScript
- [ ] Methods handle null/undefined correctly
- [ ] Service tested with real Supabase calls
- [ ] Loading states handled properly

## Files
- `src/domains/user/profile/_shared/services/profileService.ts` (new)
- `src/domains/user/profile/_shared/services/__tests__/profileService.test.ts` (new)
- `.claude/epics/user-profile/005.md` (new)

## Technical Approach

### Step 1: Create Profile Service
```typescript
// src/domains/user/profile/_shared/services/profileService.ts
import { supabase } from '@/lib/supabase/client'
import type { Profile, ProfileUpdate } from '../types'

/**
 * Profile Service
 * Handles all profile-related API operations
 */
export const profileService = {
  /**
   * Get user profile by ID
   * @param userId - User ID (defaults to current user)
   * @returns Profile data or null
   */
  async getProfile(userId?: string): Promise<Profile | null> {
    try {
      // Get current user if userId not provided
      const { data: { user } } = await supabase.auth.getUser()
      const targetUserId = userId || user?.id

      if (!targetUserId) {
        throw new Error('No user ID provided')
      }

      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', targetUserId)
        .single()

      if (error) {
        // Profile doesn't exist yet
        if (error.code === 'PGRST116') {
          return null
        }
        throw error
      }

      return data
    } catch (error) {
      console.error('Error fetching profile:', error)
      throw new Error('Failed to fetch profile. Please try again.')
    }
  },

  /**
   * Update user profile
   * @param userId - User ID
   * @param updates - Profile data to update
   * @returns Updated profile
   */
  async updateProfile(
    userId: string,
    updates: ProfileUpdate
  ): Promise<Profile> {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .update({
          ...updates,
          updated_at: new Date().toISOString()
        })
        .eq('id', userId)
        .select()
        .single()

      if (error) throw error

      return data
    } catch (error) {
      console.error('Error updating profile:', error)
      throw new Error('Failed to update profile. Please try again.')
    }
  },

  /**
   * Create new profile (for new users)
   * @param userId - User ID
   * @param profileData - Initial profile data
   * @returns Created profile
   */
  async createProfile(
    userId: string,
    profileData: Partial<Profile> = {}
  ): Promise<Profile> {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .insert({
          id: userId,
          name: profileData.name || null,
          bio: profileData.bio || null,
          avatar_url: profileData.avatar_url || null,
          location: profileData.location || null,
          timezone: profileData.timezone || null,
          twitter_url: profileData.twitter_url || null,
          linkedin_url: profileData.linkedin_url || null,
          youtube_url: profileData.youtube_url || null,
          instagram_url: profileData.instagram_url || null,
          sisos_tokens: 0
        })
        .select()
        .single()

      if (error) throw error

      return data
    } catch (error) {
      console.error('Error creating profile:', error)
      throw new Error('Failed to create profile. Please try again.')
    }
  },

  /**
   * Soft delete profile (schedule deletion)
   * @param userId - User ID
   * @returns Updated profile with deletion scheduled
   */
  async scheduleDeletion(userId: string): Promise<Profile> {
    try {
      // Schedule deletion for 24 hours from now
      const deletionDate = new Date()
      deletionDate.setHours(deletionDate.getHours() + 24)

      const { data, error } = await supabase
        .from('profiles')
        .update({
          deletion_scheduled: deletionDate.toISOString(),
          updated_at: new Date().toISOString()
        })
        .eq('id', userId)
        .select()
        .single()

      if (error) throw error

      return data
    } catch (error) {
      console.error('Error scheduling deletion:', error)
      throw new Error('Failed to schedule deletion. Please try again.')
    }
  },

  /**
   * Cancel scheduled deletion
   * @param userId - User ID
   * @returns Updated profile
   */
  async cancelDeletion(userId: string): Promise<Profile> {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .update({
          deletion_scheduled: null,
          updated_at: new Date().toISOString()
        })
        .eq('id', userId)
        .select()
        .single()

      if (error) throw error

      return data
    } catch (error) {
      console.error('Error canceling deletion:', error)
      throw new Error('Failed to cancel deletion. Please try again.')
    }
  },

  /**
   * Permanently delete profile (hard delete)
   * Note: This should only be called by background jobs after grace period
   * @param userId - User ID
   * @returns Success status
   */
  async deleteProfile(userId: string): Promise<boolean> {
    try {
      const { error } = await supabase
        .from('profiles')
        .delete()
        .eq('id', userId)

      if (error) throw error

      return true
    } catch (error) {
      console.error('Error deleting profile:', error)
      throw new Error('Failed to delete profile. Please try again.')
    }
  },

  /**
   * Check if deletion is scheduled
   * @param userId - User ID
   * @returns Deletion status
   */
  async getDeletionStatus(userId: string): Promise<{
    deletion_scheduled: boolean
    deletion_date: string | null
  }> {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('deletion_scheduled')
        .eq('id', userId)
        .single()

      if (error) throw error

      return {
        deletion_scheduled: data.deletion_scheduled !== null,
        deletion_date: data.deletion_scheduled
      }
    } catch (error) {
      console.error('Error checking deletion status:', error)
      throw new Error('Failed to check deletion status. Please try again.')
    }
  }
}
```

### Step 2: Create Service Tests
```typescript
// src/domains/user/profile/_shared/services/__tests__/profileService.test.ts
import { describe, it, expect, beforeEach, vi } from 'vitest'
import { profileService } from '../profileService'

// Mock Supabase client
vi.mock('@/lib/supabase/client', () => ({
  supabase: {
    from: vi.fn(() => ({
      select: vi.fn(() => ({
        eq: vi.fn(() => ({
          single: vi.fn(),
          update: vi.fn(() => ({
            select: vi.fn(() => ({
              single: vi.fn()
            }))
          })),
          delete: vi.fn()
        }))
      })),
      insert: vi.fn(() => ({
        select: vi.fn(() => ({
          single: vi.fn()
        }))
      }))
    })),
    auth: {
      getUser: vi.fn()
    }
  }
}))

describe('profileService', () => {
  const mockProfile = {
    id: 'user-123',
    name: 'John Doe',
    bio: 'Software developer',
    avatar_url: null,
    location: 'SF',
    timezone: 'PST',
    twitter_url: null,
    linkedin_url: null,
    youtube_url: null,
    instagram_url: null,
    sisos_tokens: 0,
    created_at: '2024-01-01',
    updated_at: '2024-01-01'
  }

  describe('getProfile', () => {
    it('should fetch user profile', async () => {
      // Test implementation
      const result = await profileService.getProfile('user-123')
      expect(result).toBeDefined()
    })

    it('should handle profile not found', async () => {
      // Test implementation
      const result = await profileService.getProfile('nonexistent')
      expect(result).toBeNull()
    })
  })

  describe('updateProfile', () => {
    it('should update profile data', async () => {
      const updates = { bio: 'Updated bio' }
      const result = await profileService.updateProfile('user-123', updates)
      expect(result.bio).toBe('Updated bio')
    })
  })
})
```

### Step 3: Test with Real Supabase
```typescript
// scripts/test-profile-service.ts
import { createClient } from '@supabase/supabase-js'
import { profileService } from '../src/domains/user/profile/_shared/services/profileService'

const supabase = createClient(
  process.env.VITE_SUPABASE_URL!,
  process.env.VITE_SUPABASE_ANON_KEY!
)

async function testProfileService() {
  console.log('Testing profile service...')

  // Get current user
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    console.error('No authenticated user')
    return
  }

  // Test 1: Get profile
  console.log('\n1. Testing getProfile()...')
  try {
    const profile = await profileService.getProfile(user.id)
    console.log('✓ Profile fetched:', profile?.name || 'No profile yet')
  } catch (error) {
    console.error('✗ Failed:', error)
  }

  // Test 2: Update profile
  console.log('\n2. Testing updateProfile()...')
  try {
    const updated = await profileService.updateProfile(user.id, {
      bio: 'Test bio at ' + new Date().toISOString()
    })
    console.log('✓ Profile updated:', updated.bio)
  } catch (error) {
    console.error('✗ Failed:', error)
  }

  console.log('\nAll tests completed!')
}

testProfileService()
```

## Dependencies
- Task 004 (TypeScript types must be defined first)

## Conflicts
None

## Testing
```bash
# Run unit tests
npm run test -- profileService

# Run integration test with real Supabase
npm run test-profile-service

# Test with manual script
node scripts/test-profile-service.ts
```

## Verification
- [ ] Service file created with all methods
- [ ] getProfile() works correctly
- [ ] updateProfile() works correctly
- [ ] createProfile() works correctly
- [ ] scheduleDeletion() works correctly
- [ ] cancelDeletion() works correctly
- [ ] deleteProfile() works correctly
- [ ] Error handling implemented
- [ ] TypeScript types are correct
- [ ] Tests pass

## Notes
- Use single() for queries that expect one result
- Handle PGRST116 error (not found) gracefully
- Always include updated_at in updates
- Use service role key for admin operations
- Consider adding retry logic for failed requests
- Add request/response logging in development
