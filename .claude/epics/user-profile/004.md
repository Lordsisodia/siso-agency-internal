---
name: Create TypeScript Types and Validation Schemas
status: open
created: 2026-01-18T08:24:04Z
parallel: true
effort: 2 hours
depends_on: [001]
conflicts_with: []
---

# Task: 004 - Create TypeScript Types and Validation Schemas

## Specification
Define TypeScript types and Zod validation schemas for all profile-related data structures. This provides type safety and runtime validation throughout the application.

## Acceptance Criteria
- [ ] `Profile` type defined with all fields
- [ ] `ProfileUpdate` type defined for partial updates
- [ ] `PrivacySettings` type defined
- [ ] `AvatarUpload` type defined
- [ ] Zod schema created for Profile validation
- [ ] Zod schema created for ProfileUpdate validation
- [ ] Zod schema created for social links validation
- [ ] Validation schemas exported and documented
- [ ] Types match database schema exactly
- [ ] Type tests pass

## Files
- `src/domains/user/profile/_shared/types/profile.types.ts` (new)
- `src/domains/user/profile/_shared/types/avatar.types.ts` (new)
- `src/domains/user/profile/_shared/types/privacy.types.ts` (new)
- `src/domains/user/profile/_shared/types/index.ts` (new)
- `src/domains/user/profile/_shared/utils/validators.ts` (new)
- `src/domains/user/profile/_shared/utils/index.ts` (new)

## Technical Approach

### Step 1: Create Profile Types
```typescript
// src/domains/user/profile/_shared/types/profile.types.ts
import { z } from 'zod'

/**
 * Raw profile data from database
 */
export interface Profile {
  id: string
  name: string | null
  bio: string | null
  avatar_url: string | null
  location: string | null
  timezone: string | null
  twitter_url: string | null
  linkedin_url: string | null
  youtube_url: string | null
  instagram_url: string | null
  sisos_tokens: number
  created_at: string
  updated_at: string
}

/**
 * Profile data for updates (all fields optional)
 */
export interface ProfileUpdate {
  name?: string | null
  bio?: string | null
  location?: string | null
  timezone?: string | null
  twitter_url?: string | null
  linkedin_url?: string | null
  youtube_url?: string | null
  instagram_url?: string | null
}

/**
 * Social links subset
 */
export interface SocialLinks {
  twitter_url?: string | null
  linkedin_url?: string | null
  youtube_url?: string | null
  instagram_url?: string | null
}

/**
 * Zod schema for Profile validation
 */
export const profileSchema = z.object({
  id: z.string().uuid(),
  name: z.string().nullable(),
  bio: z.string().max(500).nullable(),
  avatar_url: z.string().url().nullable(),
  location: z.string().max(100).nullable(),
  timezone: z.string().max(50).nullable(),
  twitter_url: z.string().url().nullable(),
  linkedin_url: z.string().url().nullable(),
  youtube_url: z.string().url().nullable(),
  instagram_url: z.string().url().nullable(),
  sisos_tokens: z.number().int().min(0),
  created_at: z.string().datetime(),
  updated_at: z.string().datetime()
})

export type ProfileValidation = z.infer<typeof profileSchema>

/**
 * Zod schema for ProfileUpdate validation
 */
export const profileUpdateSchema = z.object({
  name: z.string().min(1).max(100).nullish(),
  bio: z.string().max(500).nullish(),
  location: z.string().max(100).nullish(),
  timezone: z.string().max(50).nullish(),
  twitter_url: z.string().url().nullish(),
  linkedin_url: z.string().url().nullish(),
  youtube_url: z.string().url().nullish(),
  instagram_url: z.string().url().nullish()
})

export type ProfileUpdateValidation = z.infer<typeof profileUpdateSchema>

/**
 * Social links validation schema
 */
export const socialLinksSchema = z.object({
  twitter_url: z.string().url().or(z.literal(null)).optional(),
  linkedin_url: z.string().url().or(z.literal(null)).optional(),
  youtube_url: z.string().url().or(z.literal(null)).optional(),
  instagram_url: z.string().url().or(z.literal(null)).optional()
})

export type SocialLinksValidation = z.infer<typeof socialLinksSchema>
```

### Step 2: Create Avatar Types
```typescript
// src/domains/user/profile/_shared/types/avatar.types.ts
import { z } from 'zod'

/**
 * Avatar upload metadata
 */
export interface AvatarUpload {
  file: File
  preview: string
  progress: number
}

/**
 * Avatar upload result
 */
export interface AvatarUploadResult {
  path: string
  publicUrl: string
}

/**
 * Avatar compression options
 */
export interface AvatarCompressionOptions {
  maxWidth: number
  maxHeight: number
  quality: number
  outputFormat: 'image/jpeg' | 'image/png' | 'image/webp'
}

/**
 * Zod schema for avatar file validation
 */
export const avatarFileSchema = z.custom<File>((file) => {
  if (!(file instanceof File)) {
    return false
  }

  // Check file type
  const validTypes = ['image/jpeg', 'image/png', 'image/webp']
  if (!validTypes.includes(file.type)) {
    return false
  }

  // Check file size (5MB max)
  const maxSize = 5 * 1024 * 1024 // 5MB in bytes
  if (file.size > maxSize) {
    return false
  }

  return true
}, {
  message: 'File must be JPG, PNG, or WebP and under 5MB'
})

/**
 * Zod schema for avatar URL validation
 */
export const avatarUrlSchema = z.string().url({
  message: 'Avatar URL must be a valid URL'
}).nullable()

export type AvatarFileValidation = z.infer<typeof avatarFileSchema>
export type AvatarUrlValidation = z.infer<typeof avatarUrlSchema>
```

### Step 3: Create Privacy Types
```typescript
// src/domains/user/profile/_shared/types/privacy.types.ts
import { z } from 'zod'

/**
 * Privacy settings for profile visibility
 */
export interface PrivacySettings {
  profile_visible: boolean
  email_visible: boolean
  bio_visible: boolean
  location_visible: boolean
  social_links_visible: boolean
}

/**
 * Data export format
 */
export interface DataExport {
  profile: {
    id: string
    name: string | null
    bio: string | null
    location: string | null
    timezone: string | null
    twitter_url: string | null
    linkedin_url: string | null
    youtube_url: string | null
    instagram_url: string | null
  }
  privacy: PrivacySettings
  exported_at: string
}

/**
 * Account deletion request
 */
export interface AccountDeletionRequest {
  reason?: string
  confirm: boolean
}

/**
 * Account deletion status
 */
export interface AccountDeletionStatus {
  deletion_scheduled: boolean
  deletion_date: string | null
  can_cancel: boolean
}

/**
 * Zod schema for privacy settings validation
 */
export const privacySettingsSchema = z.object({
  profile_visible: z.boolean(),
  email_visible: z.boolean(),
  bio_visible: z.boolean(),
  location_visible: z.boolean(),
  social_links_visible: z.boolean()
})

export type PrivacySettingsValidation = z.infer<typeof privacySettingsSchema>

/**
 * Zod schema for account deletion request
 */
export const accountDeletionRequestSchema = z.object({
  reason: z.string().max(500).optional(),
  confirm: z.literal(true, {
    errorMap: () => ({ message: 'You must confirm account deletion' })
  })
})

export type AccountDeletionRequestValidation = z.infer<typeof accountDeletionRequestSchema>
```

### Step 4: Create Index File
```typescript
// src/domains/user/profile/_shared/types/index.ts
export * from './profile.types'
export * from './avatar.types'
export * from './privacy.types'
```

### Step 5: Create Validator Utilities
```typescript
// src/domains/user/profile/_shared/utils/validators.ts
import { z } from 'zod'
import {
  profileUpdateSchema,
  socialLinksSchema,
  avatarFileSchema,
  privacySettingsSchema,
  accountDeletionRequestSchema
} from '../types'

/**
 * Validate profile update data
 */
export function validateProfileUpdate(data: unknown) {
  return profileUpdateSchema.safeParse(data)
}

/**
 * Validate social links
 */
export function validateSocialLinks(data: unknown) {
  return socialLinksSchema.safeParse(data)
}

/**
 * Validate avatar file
 */
export function validateAvatarFile(file: unknown) {
  return avatarFileSchema.safeParse(file)
}

/**
 * Validate privacy settings
 */
export function validatePrivacySettings(data: unknown) {
  return privacySettingsSchema.safeParse(data)
}

/**
 * Validate account deletion request
 */
export function validateAccountDeletionRequest(data: unknown) {
  return accountDeletionRequestSchema.safeParse(data)
}

/**
 * Format validation error for display
 */
export function formatValidationError(error: z.ZodError): string {
  return error.errors
    .map((e) => `${e.path.join('.')}: ${e.message}`)
    .join(', ')
}
```

### Step 6: Create Utilities Index
```typescript
// src/domains/user/profile/_shared/utils/index.ts
export * from './validators'
export * from './formatters'
export * from './constants'
```

### Step 7: Type Tests
```typescript
// src/domains/user/profile/_shared/types/__tests__/profile.types.test.ts
import { describe, it, expect } from 'vitest'
import { profileSchema, profileUpdateSchema } from '../profile.types'

describe('Profile Types', () => {
  it('should validate a valid profile', () => {
    const profile = {
      id: '123e4567-e89b-12d3-a456-426614174000',
      name: 'John Doe',
      bio: 'Software developer',
      avatar_url: 'https://example.com/avatar.jpg',
      location: 'San Francisco',
      timezone: 'America/Los_Angeles',
      twitter_url: 'https://twitter.com/johndoe',
      linkedin_url: null,
      youtube_url: null,
      instagram_url: null,
      sisos_tokens: 100,
      created_at: '2024-01-01T00:00:00Z',
      updated_at: '2024-01-01T00:00:00Z'
    }

    const result = profileSchema.safeParse(profile)
    expect(result.success).toBe(true)
  })

  it('should validate profile update', () => {
    const update = {
      bio: 'Updated bio',
      location: 'New York'
    }

    const result = profileUpdateSchema.safeParse(update)
    expect(result.success).toBe(true)
  })

  it('should reject invalid URL', () => {
    const update = {
      twitter_url: 'not-a-url'
    }

    const result = profileUpdateSchema.safeParse(update)
    expect(result.success).toBe(false)
  })

  it('should reject bio over 500 characters', () => {
    const update = {
      bio: 'a'.repeat(501)
    }

    const result = profileUpdateSchema.safeParse(update)
    expect(result.success).toBe(false)
  })
})
```

## Dependencies
- Task 001 (Database schema must be validated to match types)

## Conflicts
None

## Testing
```bash
# Run type checking
npm run type-check

# Run validation tests
npm run test -- profile.types

# Test validator functions
npm run test -- validators
```

## Verification
- [ ] All types defined and exported
- [ ] Zod schemas created for all types
- [ ] Types match database schema
- [ ] Validation functions work correctly
- [ ] Type tests pass
- [ ] No TypeScript errors
- [ ] Types are documented with JSDoc
- [ ] Index files export correctly

## Notes
- Use strict types - no `any` allowed
- Make all fields nullable as per database schema
- Use Zod for runtime validation
- Export types from index file for easy importing
- Add JSDoc comments for IDE support
