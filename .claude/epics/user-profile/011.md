---
name: Build AvatarUpload Component
status: open
created: 2026-01-18T08:24:04Z
parallel: true
effort: 4 hours
depends_on: [008]
conflicts_with: []
---

# Task: 011 - Build AvatarUpload Component

## Specification
Create the AvatarUpload component with drag & drop functionality, image preview, and progress tracking. This component provides a smooth avatar management experience.

## Acceptance Criteria
- [ ] `AvatarUpload` component created
- [ ] `AvatarPreview` component for image preview
- [ ] Drag & drop functionality
- [ ] Click to browse files
- [ ] File validation (type, size)
- [ ] Progress indicator during upload
- [ ] Delete button
- [ ] Default avatar fallback
- [ ] Error handling and display
- [ ] Responsive design

## Files
- `src/domains/user/profile/3-avatar/ui/components/AvatarPreview.tsx` (new)
- `src/domains/user/profile/3-avatar/ui/components/AvatarUpload.tsx` (new)
- `src/domains/user/profile/3-avatar/ui/pages/AvatarSettingsPage.tsx` (new)
- `src/domains/user/profile/3-avatar/index.ts` (new)

## Technical Approach

### Step 1: Create AvatarPreview Component
```typescript
// src/domains/user/profile/3-avatar/ui/components/AvatarPreview.tsx
import { Avatar } from '@radix-ui/react-avatar'
import { User, X } from 'lucide-react'
import { Button } from '@/components/ui/button'

interface AvatarPreviewProps {
  src: string | null
  alt: string
  size?: 'sm' | 'md' | 'lg' | 'xl'
  onRemove?: () => void
}

const sizeClasses = {
  sm: 'w-16 h-16',
  md: 'w-24 h-24',
  lg: 'w-32 h-32',
  xl: 'w-48 h-48'
}

export function AvatarPreview({ src, alt, size = 'lg', onRemove }: AvatarPreviewProps) {
  return (
    <div className="relative inline-block">
      <Avatar className={sizeClasses[size]}>
        {src ? (
          <Avatar.Image src={src} alt={alt} className="object-cover" />
        ) : (
          <Avatar.Fallback className="bg-muted">
            <User className="w-1/2 h-1/2 text-muted-foreground" />
          </Avatar.Fallback>
        )}
      </Avatar>

      {onRemove && src && (
        <Button
          size="icon"
          variant="destructive"
          className="absolute -top-2 -right-2 h-6 w-6 rounded-full"
          onClick={onRemove}
        >
          <X className="h-4 w-4" />
        </Button>
      )}
    </div>
  )
}
```

### Step 2: Create Main AvatarUpload Component
```typescript
// src/domains/user/profile/3-avatar/ui/components/AvatarUpload.tsx
import { useCallback, useState } from 'react'
import { useDropzone } from 'react-dropzone'
import { Upload, AlertCircle } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { useAvatarUpload } from '../../_shared/hooks'
import { AvatarPreview } from './AvatarPreview'

interface AvatarUploadProps {
  userId: string
  currentAvatar: string | null
}

export function AvatarUpload({ userId, currentAvatar }: AvatarUploadProps) {
  const {
    upload,
    remove,
    clearPreview,
    isUploading,
    isDeleting,
    progress,
    preview,
    error
  } = useAvatarUpload(userId)

  const [dragActive, setDragActive] = useState(false)

  const onDrop = useCallback((acceptedFiles: File[]) => {
    const file = acceptedFiles[0]
    if (file) {
      upload(file)
    }
  }, [upload])

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'image/jpeg': ['.jpg', '.jpeg'],
      'image/png': ['.png'],
      'image/webp': ['.webp']
    },
    maxFiles: 1,
    maxSize: 5 * 1024 * 1024, // 5MB
    multiple: false,
    onDragEnter: () => setDragActive(true),
    onDragLeave: () => setDragActive(false)
  })

  const handleRemove = () => {
    if (currentAvatar && !preview) {
      remove()
    } else {
      clearPreview()
    }
  }

  const displayAvatar = preview || currentAvatar

  return (
    <div className="space-y-4">
      <AvatarPreview
        src={displayAvatar}
        alt="Profile avatar"
        size="xl"
        onRemove={displayAvatar ? handleRemove : undefined}
      />

      {isUploading && (
        <div className="space-y-2">
          <Progress value={progress} />
          <p className="text-sm text-muted-foreground text-center">
            Uploading... {progress}%
          </p>
        </div>
      )}

      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {!isUploading && !isDeleting && (
        <div
          {...getRootProps()}
          className={`
            border-2 border-dashed rounded-lg p-8 text-center cursor-pointer
            transition-colors
            ${isDragActive || dragActive
              ? 'border-primary bg-primary/5'
              : 'border-muted-foreground/25 hover:border-primary'
            }
          `}
        >
          <input {...getInputProps()} />
          <Upload className="w-12 h-12 mx-auto mb-4 text-muted-foreground" />
          <p className="text-sm font-medium mb-1">
            {isDragActive ? 'Drop image here' : 'Drag & drop image here'}
          </p>
          <p className="text-xs text-muted-foreground mb-4">
            or click to browse
          </p>
          <p className="text-xs text-muted-foreground">
            JPG, PNG, or WebP (max 5MB)
          </p>
        </div>
      )}

      {isDeleting && (
        <p className="text-sm text-muted-foreground text-center">
          Removing avatar...
        </p>
      )}
    </div>
  )
}
```

### Step 3: Create Page Component
```typescript
// src/domains/user/profile/3-avatar/ui/pages/AvatarSettingsPage.tsx
import { useNavigate } from 'react-router-dom'
import { Button } from '@/components/ui/button'
import { ArrowLeft } from 'lucide-react'
import { useUserProfile } from '../../_shared/hooks'
import { useAuth } from '@/features/auth'
import { AvatarUpload } from '../components/AvatarUpload'

export function AvatarSettingsPage() {
  const navigate = useNavigate()
  const { data: { user } } = useAuth()
  const { data: profile, isLoading } = useUserProfile(user?.id)

  return (
    <div className="container max-w-2xl py-8">
      <Button
        variant="ghost"
        onClick={() => navigate('/profile')}
        className="mb-4"
      >
        <ArrowLeft className="w-4 h-4 mr-2" />
        Back to Profile
      </Button>

      <h1 className="text-3xl font-bold mb-6">Avatar Settings</h1>

      {isLoading ? (
        <p>Loading...</p>
      ) : profile ? (
        <div className="space-y-6">
          <div>
            <h2 className="text-lg font-semibold mb-4">Upload Avatar</h2>
            <AvatarUpload
              userId={profile.id}
              currentAvatar={profile.avatar_url}
            />
          </div>

          <div className="text-sm text-muted-foreground">
            <p>Your avatar is displayed on your profile and throughout the app.</p>
            <p>Recommended: Square image (400x400 pixels)</p>
          </div>
        </div>
      ) : null}
    </div>
  )
}
```

## Dependencies
- Task 008 (Custom hooks must be created)

## Conflicts
None

## Testing
```bash
# Test AvatarUpload component
npm run test -- AvatarUpload

# Test drag and drop
npm run test -- avatar-dropzone

# Test file validation
npm run test -- avatar-validation
```

## Verification
- [ ] AvatarPreview shows current avatar
- [ ] Drag & drop works
- [ ] Click to browse works
- [ ] File type validation works
- [ ] File size validation works
- [ ] Progress indicator shows
- [ ] Preview displays before upload
- [ ] Remove button works
- [ ] Error messages display
- [ ] Default avatar shows when none

## File Validation
- Types: JPG, PNG, WebP
- Max size: 5MB
- Max files: 1
- Auto-compression on upload

## UX Features
- Drag & drop zone
- Click to browse
- Image preview
- Upload progress
- Error handling
- Remove avatar
- Default fallback

## Notes
- Use react-dropzone for drag & drop
- Clean up previews to avoid memory leaks
- Show helpful error messages
- Test with various file types
- Test with large files
