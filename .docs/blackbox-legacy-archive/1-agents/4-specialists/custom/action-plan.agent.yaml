name: action-plan
type: orchestrator
version: 1.0.0
description: "Plan generation and agent assignment for user tasks"

capabilities:
  - Task understanding and classification
  - Action plan generation
  - Agent selection and assignment
  - Execution tracking

workflow:
  stages:
    - name: understand
      description: "Understand the user's task and classify it"
      actions:
        - Read task description
        - Identify task type (feature, bugfix, research, refactor, docs)
        - Assess complexity (simple, moderate, complex, critical)
        - Identify dependencies and constraints

    - name: plan
      description: "Generate a structured action plan"
      actions:
        - Break down task into actionable steps
        - Identify which agent handles each step
        - Define step dependencies
        - Estimate effort for each step

    - name: assign
      description: "Assign appropriate agents for execution"
      actions:
        - Select primary agent based on task type
        - Select supporting agents if needed
        - Create plan folder using new-plan.sh
        - Generate plan documentation

    - name: execute
      description: "Track execution progress"
      actions:
        - Monitor step completion
        - Update status.md with progress
        - Handle blockers and dependencies
        - Provide completion summary

task_classification:
  feature:
    simple:
      primary_agent: dev
      workflow: "dev (fast track)"
      description: "Simple feature - single component, clear requirements"
      estimated_time: "5-10 min"
      steps:
        - name: implement
          agent: dev
          output: "Code implementation + brief README"
      rationale: "Fast track for straightforward tasks that don't require extensive planning"

    moderate:
      primary_agent: pm
      workflow: "pm → dev"
      description: "Moderate feature - requires clarification and some design"
      estimated_time: "15-30 min"
      steps:
        - name: requirements
          agent: pm
          output: "Requirements document"
        - name: implement
          agent: dev
          output: "Code implementation"
      rationale: "PM clarifies requirements, Dev implements directly"

    complex:
      primary_agent: pm
      workflow: "pm → architect → dev → qa"
      description: "Complex feature - multiple components, architectural decisions"
      estimated_time: "30-60 min"
      steps:
        - name: requirements
          agent: pm
          output: "PRD document"
        - name: architecture
          agent: architect
          output: "Architecture design"
        - name: implementation
          agent: dev
          output: "Code implementation"
        - name: testing
          agent: qa
          output: "Test validation"
      rationale: "Full workflow for complex features requiring careful design"

    critical:
      primary_agent: orchestrator
      workflow: "orchestrator → pm → architect → dev → qa"
      description: "Critical feature - high complexity, high risk"
      estimated_time: "60+ min"
      steps:
        - name: assessment
          agent: orchestrator
          output: "Risk assessment and plan"
        - name: requirements
          agent: pm
          output: "Complete PRD"
        - name: architecture
          agent: architect
          output: "Detailed architecture"
        - name: implementation
          agent: dev
          output: "Production code"
        - name: testing
          agent: qa
          output: "Comprehensive test report"
      rationale: "Maximum rigor for critical features"

  bugfix:
    simple:
      primary_agent: dev
      workflow: "dev (fast fix)"
      description: "Simple bug - obvious fix, low risk"
      estimated_time: "5-10 min"
      steps:
        - name: fix
          agent: dev
          output: "Code fix"
      rationale: "Quick fix for obvious issues"

    moderate:
      primary_agent: dev
      workflow: "dev → qa"
      description: "Moderate bug - requires investigation"
      estimated_time: "10-20 min"
      steps:
        - name: investigate
          agent: dev
          output: "Root cause analysis"
        - name: fix
          agent: dev
          output: "Code fix"
        - name: validate
          agent: qa
          output: "Fix validation"
      rationale: "Investigation needed, QA validates"

    complex:
      primary_agent: architect
      workflow: "architect → dev → qa"
      description: "Complex bug - architectural issue, systemic"
      estimated_time: "20-40 min"
      steps:
        - name: analyze
          agent: architect
          output: "Root cause analysis"
        - name: plan_fix
          agent: architect
          output: "Fix strategy"
        - name: implement
          agent: dev
          output: "Code fix"
        - name: validate
          agent: qa
          output: "Comprehensive validation"
      rationale: "Architectural bugs need architect involvement"

  research:
    simple:
      primary_agent: analyst
      workflow: "analyst (quick research)"
      description: "Simple research - single question, known sources"
      estimated_time: "5-10 min"
      steps:
        - name: research
          agent: analyst
          output: "Brief findings"
      rationale: "Quick lookup for straightforward questions"

    moderate:
      primary_agent: analyst
      workflow: "analyst → tech-writer"
      description: "Moderate research - multiple sources, synthesis"
      estimated_time: "15-30 min"
      steps:
        - name: research
          agent: analyst
          output: "Research data"
        - name: synthesize
          agent: analyst
          output: "Research report"
      rationale: "Multi-source research requires structure"

    complex:
      primary_agent: analyst
      workflow: "analyst (deep research)"
      description: "Complex research - comprehensive analysis"
      estimated_time: "30-60 min"
      steps:
        - name: plan_research
          agent: analyst
          output: "Research methodology"
        - name: collect_data
          agent: analyst
          output: "Research data"
        - name: analyze
          agent: analyst
          output: "Analysis and findings"
        - name: report
          agent: tech-writer
          output: "Final report"
      rationale: "Deep research benefits from structured methodology"

  refactor:
    simple:
      primary_agent: dev
      workflow: "dev (quick refactor)"
      description: "Simple refactor - single file, low risk"
      estimated_time: "5-15 min"
      steps:
        - name: refactor
          agent: dev
          output: "Refactored code"
      rationale: "Straightforward refactoring doesn't need planning"

    moderate:
      primary_agent: architect
      workflow: "architect → dev"
      description: "Moderate refactor - multiple files, design changes"
      estimated_time: "15-30 min"
      steps:
        - name: analyze
          agent: architect
          output: "Refactoring plan"
        - name: implement
          agent: dev
          output: "Refactored code"
      rationale: "Design changes need architect guidance"

    complex:
      primary_agent: architect
      workflow: "architect → dev → qa"
      description: "Complex refactor - architectural changes"
      estimated_time: "30-60 min"
      steps:
        - name: analyze
          agent: architect
          output: "Impact analysis"
        - name: design
          agent: architect
          output: "Migration plan"
        - name: implement
          agent: dev
          output: "Refactored code"
        - name: validate
          agent: qa
          output: "Validation report"
      rationale: "Architectural refactoring needs QA validation"

  docs:
    simple:
      primary_agent: tech-writer
      workflow: "tech-writer (quick docs)"
      description: "Simple docs - single file, straightforward"
      estimated_time: "5-10 min"
      steps:
        - name: write
          agent: tech-writer
          output: "Documentation"
      rationale: "Simple docs can be written directly"

    moderate:
      primary_agent: tech-writer
      workflow: "tech-writer → reviewer"
      description: "Moderate docs - multiple files, integration"
      estimated_time: "15-30 min"
      steps:
        - name: draft
          agent: tech-writer
          output: "Documentation draft"
        - name: review
          agent: pm
          output: "Reviewed documentation"
      rationale: "Moderate docs benefit from PM review"

    complex:
      primary_agent: tech-writer
      workflow: "tech-writer + sm (structured docs)"
      description: "Complex docs - comprehensive documentation"
      estimated_time: "30-60 min"
      steps:
        - name: outline
          agent: tech-writer
          output: "Documentation outline"
        - name: draft
          agent: tech-writer
          output: "Draft documentation"
        - name: review
          agent: pm
          output: "Reviewed documentation"
        - name: finalize
          agent: tech-writer
          output: "Final documentation"
      rationale: "Complex docs need structured approach"

complexity_detection:
  indicators:
    simple:
      description: "Fast track - single agent, minimal planning"
      criteria:
        - "Single component or file (< 200 lines expected)"
        - "Clear, unambiguous requirements"
        - "No architectural decisions needed"
        - "Low risk (isolated changes)"
        - "No integration with other systems"
        - "No database schema changes"
        - "No API changes"
        - "No breaking changes"
      examples:
        - "Add a button to existing form"
        - "Fix a styling bug"
        - "Add a simple validation rule"
        - "Update a text string"
        - "Add a console.log for debugging"
      workflow_trigger: "Any simple criteria met AND no moderate/complex criteria"

    moderate:
      description: "Standard workflow - some planning needed"
      criteria:
        - "2-5 components or files (< 500 lines expected)"
        - "Some clarification needed on requirements"
        - "Minor architectural decisions"
        - "Medium risk (some dependencies)"
        - "Simple API changes (add endpoint, not modify)"
        - "Database schema additions (not modifications)"
        - "Integration with 1-2 other systems"
        - "Non-breaking changes to existing functionality"
      examples:
        - "Add a new form with validation"
        - "Implement a new API endpoint"
        - "Add a new database table"
        - "Create a new page with existing components"
        - "Refactor a single module"
      workflow_trigger: "Any moderate criteria met AND no complex criteria"

    complex:
      description: "Full workflow - comprehensive planning needed"
      criteria:
        - "5+ components or files (500+ lines expected)"
        - "Multiple systems integration"
        - "Significant architectural decisions"
        - "Database schema modifications"
        - "API changes to existing endpoints"
        - "Performance considerations (100K+ records, optimization)"
        - "Security considerations (auth, permissions, sensitive data)"
        - "Breaking changes or migrations"
        - "Multiple stakeholders or teams involved"
      examples:
        - "Implement a search feature with 100K+ products"
        - "Add authentication system"
        - "Migrate database schema"
        - "Implement payment processing"
        - "Create a new module with 5+ components"
      workflow_trigger: "Any complex criteria met"

    critical:
      description: "Maximum rigor - high complexity or risk"
      criteria:
        - "System-wide changes"
        - "High risk (core functionality, data loss potential)"
        - "Multiple teams coordination required"
        - "Significant business impact"
        - "Compliance or legal requirements"
        - "Performance SLAs (must handle X load)"
        - "Security audit requirements"
      examples:
        - "Migrate from monolith to microservices"
        - "Implement GDPR compliance"
        - "Rewrite core payment system"
        - "Database migration with 1M+ records"
      workflow_trigger: "Any critical criteria met"

complexity_heuristics:
  keyword_based:
    fast_track_keywords:
      - "add a button"
      - "fix styling"
      - "update text"
      - "simple validation"
      - "change color"
      - "add field to form"
      - "update component"

    complex_keywords:
      - "search with 100K"
      - "authentication system"
      - "payment processing"
      - "database migration"
      - "microservices"
      - "performance optimization"
      - "security implementation"
      - "API redesign"
      - "breaking change"

  scope_based:
    simple_scope:
      max_files: 3
      max_components: 2
      max_integration_points: 1
      max_db_changes: 0  # additions only

    complex_scope:
      min_files: 5
      min_components: 5
      min_integration_points: 3
      requires_db_modifications: true

  risk_based:
    low_risk:
      - "Isolated changes"
      - "No data migration"
      - "No performance requirements"
      - "No security implications"

    high_risk:
      - "Core system changes"
      - "Data loss potential"
      - "Security implications"
      - "Performance SLAs"

output_schema:
  action_plan:
    id: "AP-YYYY-###"
    created_at: "ISO timestamp"
    task:
      description: "string"
      type: "feature|bugfix|research|refactor|docs"
      complexity: "simple|moderate|complex|critical"
    plan:
      steps:
        - id: "integer"
          action: "string"
          agent: "agent_name"
          depends_on: ["list of step ids"]
          status: "pending|in_progress|complete|blocked"
          estimated_effort: "string"
    execution:
      assigned_agent: "agent_name"
      plan_folder: "path to plan folder"
      current_step: "integer"
      status: "pending|in_progress|complete|blocked"

prompts:
  system: |
    You are the Action Plan Agent for Blackbox3.

    Your role is to:
    1. Understand the user's task
    2. Classify the task by type and complexity (AUTOMATICALLY)
    3. Select the appropriate workflow based on complexity
    4. Generate a structured action plan
    5. Assign appropriate agents for execution

    === AUTOMATIC WORKFLOW SELECTION ===

    Blackbox3 now uses ADAPTIVE WORKFLOWS based on task complexity.
    You must automatically detect complexity and choose the appropriate workflow.

    Task Types:
    - feature: New functionality
    - bugfix: Fix bugs
    - research: Investigation
    - refactor: Code improvements
    - docs: Documentation

    Complexity Levels (Auto-Detect Using These Criteria):

    === SIMPLE (Fast Track - Single Agent) ===
    Use when: Single component, clear requirements, low risk
    Workflow: Dev only (or Analyst for research)
    Time: 5-10 minutes
    Indicators:
      - "add a button", "fix styling", "update text"
      - Single file, <200 lines
      - No architectural decisions
      - No database changes

    === MODERATE (Standard - Two Agents) ===
    Use when: Some planning needed, multiple components
    Workflow: PM → Dev (or Architect → Dev)
    Time: 15-30 minutes
    Indicators:
      - 2-5 components, <500 lines
      - Some clarification needed
      - New API endpoint (add, not modify)
      - New database table (add, not modify)

    === COMPLEX (Full Workflow - 3-4 Agents) ===
    Use when: Comprehensive planning needed
    Workflow: PM → Architect → Dev → QA
    Time: 30-60 minutes
    Indicators:
      - 5+ components, 500+ lines
      - Database schema modifications
      - API changes to existing endpoints
      - Performance/security considerations
      - "100K+ products", "authentication", "payment"

    === CRITICAL (Maximum Rigor - 5+ Agents) ===
    Use when: High complexity or high risk
    Workflow: Orchestrator → PM → Architect → Dev → QA
    Time: 60+ minutes
    Indicators:
      - System-wide changes
      - Multiple teams coordination
      - High risk (data loss, core functionality)
      - "microservices migration", "GDPR compliance"

    === DECISION TREE ===

    1. Check for CRITICAL indicators first
       If any critical criteria found → CRITICAL workflow

    2. Check for COMPLEX indicators
       If any complex criteria found → COMPLEX workflow

    3. Check for MODERATE indicators
       If any moderate criteria found → MODERATE workflow

    4. Default to SIMPLE if no other criteria met

    === EXAMPLES ===

    "Add a submit button to login form"
    → SIMPLE (single component, clear requirements)
    → Workflow: Dev only

    "Create a user profile page with existing components"
    → MODERATE (multiple components, some assembly)
    → Workflow: PM → Dev

    "Implement search with filters for 100K+ products"
    → COMPLEX (performance, multiple systems)
    → Workflow: PM → Architect → Dev → QA

    "Migrate from monolith to microservices"
    → CRITICAL (system-wide, high risk)
    → Workflow: Orchestrator → PM → Architect → Dev → QA

    Always follow the Blackbox3 protocol:
    - Read protocol.md for system rules
    - Create plan folders using new-plan.sh
    - Save outputs to artifacts/
    - Update status.md with progress

  understand: |
    I need to understand your task. Please provide:
    1. What you want to accomplish
    2. Any constraints or requirements
    3. Desired timeline (if any)

    I will classify the task and generate an action plan.

  plan_generated: |
    Action plan generated!

    Task: {task_description}
    Type: {task_type}
    Complexity: {complexity}

    Steps:
    {steps_list}

    Assigned Agent: {agent}
    Plan Folder: {plan_folder}

    Next: Review the plan and I'll set up the assigned agent to execute.
