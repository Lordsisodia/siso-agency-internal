# Workflow: Start UI Adaptive Development Cycle
# Full end-to-end UI change execution

workflow:
  id: "custom/agents/ui-cycle/workflows/start-cycle"
  name: "Start UI Cycle"
  description: "Execute complete UI Adaptive Development Cycle"

  trigger:
    - "*ui-cycle"
    - "UC"
    - "start-ui-cycle"

  inputs:
    - name: "task"
      description: "UI change description (one line)"
      required: true
      example: "Change login button from blue to red"

    - name: "url"
      description: "Target URL to test"
      required: true
      example: "http://localhost:3000"

    - name: "component"
      description: "Component name to modify"
      required: true
      example: "LoginButton.tsx"

    - name: "type"
      description: "Change type"
      required: false
      default: "other"
      options:
        - "color"
        - "layout"
        - "text"
        - "spacing"
        - "component"
        - "other"

  phases:
    - id: "pre-flight"
      name: "Pre-Flight Check"
      duration_minutes: 2
      description: "Validate environment before starting"
      gates:
        - id: "git-clean"
          check: "git status --porcelain"
          expected: "no output"
          failure_message: "Git working directory not clean"

        - id: "dev-server"
          check: "npm run dev &"
          expected: "server starts without errors"
          failure_message: "Dev server failed to start"

      actions:
        - create_run_directory
        - save_cycle_metadata

    - id: "observe"
      name: "Observe Baseline"
      duration_minutes: 5
      description: "Capture baseline state before changes"
      actions:
        - navigate_to_url
        - capture_screenshots_before
        - capture_console_baseline
        - capture_performance_baseline
        - inspect_component

      artifacts:
        - "screenshots/before/{mobile,tablet,desktop}.png"
        - "logs/before-console.json"
        - "logs/before-performance.json"
        - "artifacts/component-map.md"

    - id: "define"
      name: "Define Success Criteria"
      duration_minutes: 10
      description: "Create unambiguous success criteria"
      actions:
        - write_success_criteria
        - generate_acceptance_test

      artifacts:
        - "artifacts/success-criteria.md"
        - "artifacts/acceptance.test.ts"

    - id: "build"
      name: "Build Changes"
      duration_minutes: 30
      description: "Make minimal, targeted changes"
      max_loops: 2
      actions:
        - backup_source_files
        - make_surgical_changes
        - run_type_check
        - run_linter
        - run_build

      gates:
        - id: "type-check"
          check: "npm run type-check"
          expected: "exit code 0"

        - id: "lint"
          check: "npm run lint"
          expected: "exit code 0"

        - id: "build"
          check: "npm run build"
          expected: "exit code 0"

      artifacts:
        - "artifacts/*.backup"
        - "logs/typecheck.log"
        - "logs/lint.log"
        - "logs/build.log"

      on_failure:
        - action: "fix_and_retry"
        - max_loops: 2
        - escalate_after_limit: true

    - id: "verify"
      name: "Verify Changes"
      duration_minutes: 15
      description: "Automated validation against success criteria"
      max_loops: 2
      actions:
        - run_acceptance_tests
        - capture_screenshots_after
        - check_console_clean
        - run_visual_regression
        - run_accessibility_audit
        - check_performance

      gates:
        - id: "tests"
          check: "npx playwright test"
          expected: "all tests pass"

        - id: "console"
          check: "console error count"
          expected: "zero errors"

        - id: "visual"
          check: "pixel difference ratio"
          expected: "< 5%"

        - id: "a11y"
          check: "accessibility score"
          expected: "> 90"

        - id: "performance"
          check: "performance vs baseline"
          expected: "within 10%"

      artifacts:
        - "screenshots/after/{mobile,tablet,desktop}.png"
        - "logs/test-results.json"
        - "logs/after-console.json"
        - "logs/accessibility.json"
        - "logs/after-performance.json"

      on_failure:
        - action: "loop_to_build"
        - max_loops: 2
        - escalate_after_limit: true

    - id: "deploy"
      name: "Deploy to Production"
      duration_minutes: 5
      description: "Ship to production with verification"
      actions:
        - commit_changes
        - create_feature_branch
        - push_to_remote
        - create_pull_request
        - deploy_to_production
        - verify_production_url
        - check_production_console
        - capture_production_screenshot

      gates:
        - id: "production-url"
          check: "deployment URL accessible"
          expected: "200 OK"

        - id: "production-console"
          check: "production console errors"
          expected: "zero errors"

      artifacts:
        - "git-commit-sha.txt"
        - "deployment-url.txt"
        - "screenshots/production.png"

      on_failure:
        - action: "rollback"
        - escalate: true

    - id: "close"
      name: "Close & Archive"
      duration_minutes: 3
      description: "Archive artifacts and generate report"
      actions:
        - generate_cycle_report
        - archive_artifacts
        - update_index
        - cleanup_local_directory

      artifacts:
        - "cycle-report.md"
        - "/archive/ui-cycles/{timestamp}/**"

  outputs:
    - name: "status"
      description: "Cycle completion status"
      type: "enum"
      values: ["success", "failed", "escalated"]

    - name: "cycle_id"
      description: "Timestamp-based cycle identifier"
      type: "string"

    - name: "commit_sha"
      description: "Git commit SHA"
      type: "string"

    - name: "deployment_url"
      description: "Live production URL"
      type: "string"

    - name: "archive_path"
      description: "Path to archived artifacts"
      type: "string"

    - name: "cycle_report"
      description: "Path to cycle report"
      type: "string"

    - name: "verification_summary"
      description: "Summary of all verification gates"
      type: "object"
      properties:
        tests: "string"
        console: "string"
        visual: "string"
        a11y: "number"
        performance: "string"

  escalation:
    trigger_conditions:
      - "build_loops >= 2"
      - "verify_loops >= 2"
      - "total_time_minutes > 90"
      - "production_deployment_failed"

    escalation_template: |
      ## ðŸš¨ UI Cycle Escalation

      **Cycle ID:** {cycle_id}
      **Task:** {task}
      **Phase:** {current_phase}
      **Loop Count:** {loop_count}/2

      ### What Happened
      {steps_taken}

      ### Specific Error
      {error_message}

      ### What I Tried
      {attempts}

      ### Artifacts for Review
      - {run_dir}/screenshots/before/
      - {run_dir}/screenshots/after/
      - {run_dir}/logs/

      ### Suggested Actions
      {suggestions}

  success_criteria:
    all:
      - "all pre-flight gates passed"
      - "all build gates passed"
      - "all verify gates passed"
      - "production deployed successfully"
      - "production console clean"
      - "cycle report generated"
      - "artifacts archived"

  references:
    - "/Black Box Factory/UI-ADAPTIVE-DEV-CYCLE.md"
    - "/Black Box Factory/UI-CYCLE-QUICK-START.md"
    - "../.skills/ui-cycle.md"
    - "prompt.md"
