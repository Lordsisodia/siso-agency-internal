#!/usr/bin/env python3
"""
Blackbox4 Semantic Search CLI
Quick search across all your work
"""

import sys
from pathlib import Path

# Add services to path
sys.path.insert(0, str(Path(__file__).parent / '.memory' / 'extended' / 'services'))

from hybrid_embedder import HybridEmbedder
from vector_store import VectorStore

def search_memory(query: str, max_results: int = 5):
    """Search memory semantically"""
    embedder = HybridEmbedder()
    store = VectorStore()

    # Embed query
    query_embedding = embedder.embed(query)

    # Search
    results = store.search(query_embeddings=[query_embedding], n_results=max_results)

    if not results or 'ids' not in results or not results['ids'][0]:
        print(f'âŒ No results found for: "{query}"')
        return

    # Display results
    print(f'\nðŸ” Search: "{query}"')
    print(f'ðŸ“Š Found {len(results["ids"][0])} results:\n')

    for i, (doc_id, distance) in enumerate(zip(results['ids'][0], results['distances'][0])):
        similarity = 1 - distance
        metadata = results['metadatas'][0][i] if 'metadatas' in results else {}

        print(f'{i+1}. Similarity: {similarity:.2f}')

        if metadata.get('type') == 'task':
            print(f'   ðŸ“‹ Task: {metadata.get("title", "Unknown")}')
            print(f'   ðŸ“ {metadata.get("id", "")}')
            print(f'   ðŸ“Š Status: {metadata.get("status", "unknown")} | Priority: {metadata.get("priority", "unknown")}')
            print(f'   ðŸ¤– Agent: {metadata.get("agent", "unassigned")}')

            # Get description
            if 'documents' in results:
                doc_text = results['documents'][0][i]
                if len(doc_text) > 100:
                    print(f'   ðŸ“„ {doc_text[:100]}...')
                else:
                    print(f'   ðŸ“„ {doc_text}')
        else:
            if 'documents' in results:
                doc_text = results['documents'][0][i]
                print(f'   ðŸ“„ {doc_text[:150]}...')

        print()

def main():
    if len(sys.argv) < 2:
        print('ðŸ” Blackbox4 Semantic Search')
        print('\nUsage:')
        print('  ./search-memory "your query"')
        print('  ./search-memory "WebSocket implementation"')
        print('  ./search-memory "security vulnerabilities"')
        print('\nExamples:')
        print('  ./search-memory "database optimization"')
        print('  ./search-memory "API documentation"')
        print('  ./search-memory "dashboard UI"')
        sys.exit(1)

    query = ' '.join(sys.argv[1:])
    search_memory(query)

if __name__ == '__main__':
    main()
