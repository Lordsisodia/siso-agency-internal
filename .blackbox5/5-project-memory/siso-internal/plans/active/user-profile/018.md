---
name: Performance Optimization and Accessibility Audit
status: open
created: 2026-01-18T08:24:04Z
parallel: true
effort: 4 hours
depends_on: [016, 017]
conflicts_with: []
---

# Task: 018 - Performance Optimization and Accessibility Audit

## Specification
Optimize performance and ensure accessibility standards are met. This task ensures the profile feature is fast, efficient, and usable by everyone.

## Acceptance Criteria
- [ ] Images optimized (lazy loading, compression)
- [ ] Components lazy loaded
- [ ] Queries optimized with proper caching
- [ ] Bundle size analyzed and optimized
- [ ] Lighthouse score > 90
- [ ] ARIA labels on all interactive elements
- [ ] Keyboard navigation works
- [ ] Screen reader tested
- [ ] Color contrast meets WCAG AA
- [ ] Focus indicators visible

## Files
- `src/domains/user/profile/_shared/utils/performance.ts` (new)
- `src/domains/user/profile/_shared/utils/accessibility.ts` (new)
- `.claude/epics/user-profile/018.md` (new)

## Technical Approach

### Step 1: Optimize Images
```typescript
// src/domains/user/profile/_shared/utils/performance.ts
/**
 * Lazy load images with intersection observer
 */
export function lazyLoadImages() {
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const img = entry.target as HTMLImageElement
          if (img.dataset.src) {
            img.src = img.dataset.src
            img.classList.remove('lazy')
            imageObserver.unobserve(img)
          }
        }
      })
    })

    document.querySelectorAll('img.lazy').forEach((img) => {
      imageObserver.observe(img)
    })
  }
}

/**
 * Generate responsive image sizes
 */
export function getResponsiveImageSizes(baseUrl: string): {
  src: string
  srcSet: string
  sizes: string
} {
  return {
    src: `${baseUrl}?w=400`,
    srcSet: `
      ${baseUrl}?w=200 200w,
      ${baseUrl}?w=400 400w,
      ${baseUrl}?w=800 800w
    `,
    sizes: '(max-width: 640px) 200px, (max-width: 1024px) 400px, 800px'
  }
}

/**
 * Preload critical images
 */
export function preloadImage(url: string): Promise<void> {
  return new Promise((resolve, reject) => {
    const img = new Image()
    img.onload = () => resolve()
    img.onerror = reject
    img.src = url
  })
}
```

### Step 2: Optimize Component Loading
```typescript
// Already implemented in routes.tsx
// But verify lazy loading is working:

import { lazy, Suspense } from 'react'

const ProfileDisplayPage = lazy(() =>
  import('./1-display/ui/pages/ProfileDisplayPage')
)

// Wrap with Suspense and loading fallback
<Suspense fallback={<ProfileSkeleton />}>
  <ProfileDisplayPage />
</Suspense>
```

### Step 3: Optimize TanStack Query Caching
```typescript
// src/domains/user/profile/_shared/hooks/useUserProfile.ts
export function useUserProfile(userId?: string) {
  return useQuery({
    queryKey: ['profile', userId],
    queryFn: () => profileService.getProfile(userId),
    staleTime: 5 * 60 * 1000, // 5 minutes - don't refetch if fresh
    gcTime: 10 * 60 * 1000, // 10 minutes - keep in cache
    refetchOnWindowFocus: false, // Don't refetch on tab switch
    refetchOnMount: false, // Don't refetch if already in cache
    retry: 1 // Only retry once on failure
  })
}
```

### Step 4: Add Accessibility Utilities
```typescript
// src/domains/user/profile/_shared/utils/accessibility.ts
/**
 * Generate ARIA labels for social links
 */
export function getSocialLinkAria(platform: string, username?: string): string {
  if (username) {
    return `Visit ${username} on ${platform}`
  }
  return `Visit ${platform} profile`
}

/**
 * Announce screen reader messages
 */
export function announceToScreenReader(message: string): void {
  const announcement = document.createElement('div')
  announcement.setAttribute('role', 'status')
  announcement.setAttribute('aria-live', 'polite')
  announcement.setAttribute('aria-atomic', 'true')
  announcement.className = 'sr-only'
  announcement.textContent = message

  document.body.appendChild(announcement)

  setTimeout(() => {
    document.body.removeChild(announcement)
  }, 1000)
}

/**
 * Trap focus in modal
 */
export function trapFocus(element: HTMLElement): () => void {
  const focusableElements = element.querySelectorAll(
    'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
  )

  const firstElement = focusableElements[0] as HTMLElement
  const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement

  const handleTab = (e: KeyboardEvent) => {
    if (e.key !== 'Tab') return

    if (e.shiftKey) {
      if (document.activeElement === firstElement) {
        lastElement.focus()
        e.preventDefault()
      }
    } else {
      if (document.activeElement === lastElement) {
        firstElement.focus()
        e.preventDefault()
      }
    }
  }

  element.addEventListener('keydown', handleTab)
  firstElement.focus()

  return () => {
    element.removeEventListener('keydown', handleTab)
  }
}

/**
 * Check color contrast (WCAG AA requires 4.5:1 for normal text)
 */
export function checkColorContrast(
  foreground: string,
  background: string
): { ratio: number; passes: boolean } {
  // Get RGB values
  const fg = getRGB(foreground)
  const bg = getRGB(background)

  // Calculate relative luminance
  const fgLuminance = getLuminance(fg.r, fg.g, fg.b)
  const bgLuminance = getLuminance(bg.r, bg.g, bg.b)

  // Calculate contrast ratio
  const lighter = Math.max(fgLuminance, bgLuminance)
  const darker = Math.min(fgLuminance, bgLuminance)
  const ratio = (lighter + 0.05) / (darker + 0.05)

  return {
    ratio,
    passes: ratio >= 4.5 // WCAG AA for normal text
  }
}

function getRGB(color: string): { r: number; g: number; b: number } {
  // Simplified - use a proper color library in production
  const match = color.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i)
  if (!match) return { r: 0, g: 0, b: 0 }

  return {
    r: parseInt(match[1], 16),
    g: parseInt(match[2], 16),
    b: parseInt(match[3], 16)
  }
}

function getLuminance(r: number, g: number, b: number): number {
  const [rs, gs, bs] = [r, g, b].map((c) => {
    c = c / 255
    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)
  })
  return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs
}
```

### Step 5: Update Components with ARIA Labels
```typescript
// Example updates for accessibility

// SocialLinks component
{links.map((link) => {
  const Icon = link.icon
  return (
    <Button
      key={link.label}
      variant="ghost"
      size="icon"
      asChild
      aria-label={getSocialLinkAria(link.label)}
    >
      <a
        href={link.url!}
        target="_blank"
        rel="noopener noreferrer"
      >
        <Icon className={`w-5 h-5 ${link.color}`} />
        <span className="sr-only">{link.label}</span>
      </a>
    </Button>
  )
})}

// Form fields
<FormField
  control={control}
  name="bio"
  render={({ field }) => (
    <FormItem>
      <Label htmlFor="bio">Bio</Label>
      <FormControl>
        <Textarea
          id="bio"
          aria-describedby="bio-description bio-counter"
          {...field}
        />
      </FormControl>
      <FormMessage />
      <span id="bio-description" className="sr-only">
        Tell us about yourself in 500 characters or less
      </span>
      <span id="bio-counter" aria-live="polite">
        {bio.length} / 500
      </span>
    </FormItem>
  )}
/>
```

### Step 6: Create Performance Monitoring
```typescript
// src/domains/user/profile/_shared/utils/monitoring.ts
/**
 * Measure page load performance
 */
export function measurePageLoad() {
  if (typeof window === 'undefined' || !window.performance) return

  window.addEventListener('load', () => {
    setTimeout(() => {
      const perfData = window.performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming

      const metrics = {
        dns: perfData.domainLookupEnd - perfData.domainLookupStart,
        tcp: perfData.connectEnd - perfData.connectStart,
        ttfb: perfData.responseStart - perfData.requestStart,
        download: perfData.responseEnd - perfData.responseStart,
        domLoad: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
        totalLoad: perfData.loadEventEnd - perfData.navigationStart
      }

      console.log('Performance Metrics:', metrics)

      // Send to analytics
      if (window.gtag) {
        window.gtag('event', 'timing_complete', {
          name: 'load',
          value: metrics.totalLoad
        })
      }
    }, 0)
  })
}

/**
 * Monitor Web Vitals
 */
export function monitorWebVitals() {
  if (typeof window === 'undefined') return

  // Import web-vitals library
  import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
    getCLS(console.log)
    getFID(console.log)
    getFCP(console.log)
    getLCP(console.log)
    getTTFB(console.log)
  })
}
```

### Step 7: Run Lighthouse Audit
```bash
# Run Lighthouse CI
npm install -g @lhci/cli
lhci autorun
```

## Dependencies
- Task 016 (Unit tests must pass)
- Task 017 (Component tests must pass)

## Conflicts
None

## Testing
```bash
# Run Lighthouse audit
npm run lighthouse

# Check bundle size
npm run analyze:bundle

# Test accessibility with axe
npm run test:a11y

# Performance profiling
npm run profile
```

## Verification
- [ ] Images lazy loaded
- [ ] Components code split
- [ ] Queries cached properly
- [ ] Bundle size optimized
- [ ] Lighthouse score > 90
- [ ] All ARIA labels present
- [ ] Keyboard navigation works
- [ ] Screen reader tested
- [ ] Color contrast passes
- [ ] Focus indicators visible

## Performance Checklist
- [ ] Lazy loading for images
- [ ] Code splitting for routes
- [ ] Proper cache strategies
- [ ] Optimized queries
- [ ] Minimal re-renders
- [ ] Efficient state updates
- [ ] Bundle size analyzed
- [ ] No memory leaks
- [ ] Fast initial load
- [ ] Smooth interactions

## Accessibility Checklist
- [ ] Semantic HTML
- [ ] ARIA labels correct
- [ ] Keyboard navigation
- [ ] Focus management
- [ ] Screen reader tested
- [ ] Color contrast WCAG AA
- [ ] Text resizable
- [ ] Error messages accessible
- [ ] Forms properly labeled
- [ ] Modals trap focus

## Notes
- Test with screen readers (NVDA, JAWS, VoiceOver)
- Test keyboard navigation
- Test with browser zoom
- Test on mobile devices
- Monitor Core Web Vitals
- Regular performance audits
