---
name: Implement Privacy Service
status: open
created: 2026-01-18T08:24:04Z
parallel: true
effort: 2 hours
depends_on: [004]
conflicts_with: []
---

# Task: 007 - Implement Privacy Service

## Specification
Create the privacy service that handles data export and privacy settings management. This service ensures GDPR/CCPA compliance for user data.

## Acceptance Criteria
- [ ] `privacyService.ts` created with all methods
- [ ] `updatePrivacySettings()` method updates visibility
- [ ] `exportUserData()` method exports all user data
- [ ] Export formatted as JSON
- [ ] Export includes timestamp
- [ ] Proper error handling
- [ ] Type-safe implementation
- [ ] Service tested with real data

## Files
- `src/domains/user/profile/_shared/services/privacyService.ts` (new)
- `src/domains/user/profile/_shared/services/__tests__/privacyService.test.ts` (new)
- `.claude/epics/user-profile/007.md` (new)

## Technical Approach

### Step 1: Create Privacy Service
```typescript
// src/domains/user/profile/_shared/services/privacyService.ts
import { supabase } from '@/lib/supabase/client'
import type { PrivacySettings, DataExport } from '../types'

/**
 * Privacy Service
 * Handles privacy settings and data export
 */
export const privacyService = {
  /**
   * Update user privacy settings
   * @param userId - User ID
   * @param settings - Privacy settings to update
   * @returns Updated privacy settings
   */
  async updatePrivacySettings(
    userId: string,
    settings: Partial<PrivacySettings>
  ): Promise<PrivacySettings> {
    try {
      // First, get current settings
      const { data: current } = await supabase
        .from('profiles')
        .select('privacy_settings')
        .eq('id', userId)
        .single()

      const currentSettings = current?.privacy_settings || {
        profile_visible: false,
        email_visible: false,
        bio_visible: false,
        location_visible: false,
        social_links_visible: false
      }

      // Merge with new settings
      const updatedSettings = {
        ...currentSettings,
        ...settings
      }

      // Update in database
      const { data, error } = await supabase
        .from('profiles')
        .update({
          privacy_settings: updatedSettings,
          updated_at: new Date().toISOString()
        })
        .eq('id', userId)
        .select('privacy_settings')
        .single()

      if (error) throw error

      return data.privacy_settings
    } catch (error) {
      console.error('Error updating privacy settings:', error)
      throw new Error('Failed to update privacy settings. Please try again.')
    }
  },

  /**
   * Get user privacy settings
   * @param userId - User ID
   * @returns Privacy settings
   */
  async getPrivacySettings(userId: string): Promise<PrivacySettings> {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('privacy_settings')
        .eq('id', userId)
        .single()

      if (error) throw error

      return data.privacy_settings || {
        profile_visible: false,
        email_visible: false,
        bio_visible: false,
        location_visible: false,
        social_links_visible: false
      }
    } catch (error) {
      console.error('Error getting privacy settings:', error)
      throw new Error('Failed to get privacy settings. Please try again.')
    }
  },

  /**
   * Export all user data (GDPR/CCPA compliance)
   * @param userId - User ID
   * @returns User data export
   */
  async exportUserData(userId: string): Promise<DataExport> {
    try {
      // Get profile data
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single()

      if (profileError) throw profileError

      // Get privacy settings
      const privacySettings = await this.getPrivacySettings(userId)

      // Format export data
      const exportData: DataExport = {
        profile: {
          id: profile.id,
          name: profile.name,
          bio: profile.bio,
          location: profile.location,
          timezone: profile.timezone,
          twitter_url: profile.twitter_url,
          linkedin_url: profile.linkedin_url,
          youtube_url: profile.youtube_url,
          instagram_url: profile.instagram_url
        },
        privacy: privacySettings,
        exported_at: new Date().toISOString()
      }

      return exportData
    } catch (error) {
      console.error('Error exporting user data:', error)
      throw new Error('Failed to export data. Please try again.')
    }
  },

  /**
   * Download data export as JSON file
   * @param userId - User ID
   * @returns Download URL for exported data
   */
  async downloadDataExport(userId: string): Promise<string> {
    try {
      const exportData = await this.exportUserData(userId)

      // Create JSON blob
      const json = JSON.stringify(exportData, null, 2)
      const blob = new Blob([json], { type: 'application/json' })
      const url = URL.createObjectURL(blob)

      // Create download link
      const link = document.createElement('a')
      link.href = url
      link.download = `siso-data-export-${userId}-${Date.now()}.json`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)

      // Clean up
      URL.revokeObjectURL(url)

      return 'Download started'
    } catch (error) {
      console.error('Error downloading data export:', error)
      throw new Error('Failed to download data export. Please try again.')
    }
  },

  /**
   * Check if profile is visible to public
   * @param userId - User ID
   * @returns Visibility status
   */
  async isProfileVisible(userId: string): Promise<boolean> {
    try {
      const settings = await this.getPrivacySettings(userId)
      return settings.profile_visible
    } catch (error) {
      console.error('Error checking profile visibility:', error)
      return false // Default to private on error
    }
  },

  /**
   * Make profile private by default (for new users)
   * @param userId - User ID
   * @returns Created privacy settings
   */
  async initializePrivacySettings(userId: string): Promise<PrivacySettings> {
    const defaultSettings: PrivacySettings = {
      profile_visible: false,
      email_visible: false,
      bio_visible: false,
      location_visible: false,
      social_links_visible: false
    }

    return this.updatePrivacySettings(userId, defaultSettings)
  }
}
```

### Step 2: Create Service Tests
```typescript
// src/domains/user/profile/_shared/services/__tests__/privacyService.test.ts
import { describe, it, expect, vi } from 'vitest'
import { privacyService } from '../privacyService'

// Mock Supabase client
vi.mock('@/lib/supabase/client', () => ({
  supabase: {
    from: vi.fn(() => ({
      select: vi.fn(() => ({
        eq: vi.fn(() => ({
          single: vi.fn()
        }))
      })),
      update: vi.fn(() => ({
        eq: vi.fn(() => ({
          select: vi.fn(() => ({
            single: vi.fn()
          }))
        }))
      }))
    }))
  }
}))

describe('privacyService', () => {
  const mockPrivacySettings = {
    profile_visible: false,
    email_visible: false,
    bio_visible: false,
    location_visible: false,
    social_links_visible: false
  }

  describe('updatePrivacySettings', () => {
    it('should update privacy settings', async () => {
      const updates = { profile_visible: true }
      const result = await privacyService.updatePrivacySettings('user-123', updates)

      expect(result.profile_visible).toBe(true)
    })

    it('should merge with existing settings', async () => {
      const result = await privacyService.updatePrivacySettings('user-123', {
        email_visible: true
      })

      expect(result).toHaveProperty('profile_visible')
      expect(result.email_visible).toBe(true)
    })
  })

  describe('exportUserData', () => {
    it('should export all user data', async () => {
      const exportData = await privacyService.exportUserData('user-123')

      expect(exportData).toHaveProperty('profile')
      expect(exportData).toHaveProperty('privacy')
      expect(exportData).toHaveProperty('exported_at')
      expect(exportData.profile.id).toBe('user-123')
    })

    it('should include timestamp', async () => {
      const exportData = await privacyService.exportUserData('user-123')

      expect(exportData.exported_at).toBeDefined()
      expect(new Date(exportData.exported_at)).toBeInstanceOf(Date)
    })
  })

  describe('isProfileVisible', () => {
    it('should return visibility status', async () => {
      const isVisible = await privacyService.isProfileVisible('user-123')

      expect(typeof isVisible).toBe('boolean')
    })
  })
})
```

### Step 3: Test Export Functionality
```typescript
// scripts/test-privacy-export.ts
import { privacyService } from '../src/domains/user/profile/_shared/services/privacyService'
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.VITE_SUPABASE_URL!,
  process.env.VITE_SUPABASE_ANON_KEY!
)

async function testPrivacyExport() {
  console.log('Testing privacy export...')

  // Get current user
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    console.error('No authenticated user')
    return
  }

  // Test 1: Get privacy settings
  console.log('\n1. Testing getPrivacySettings()...')
  try {
    const settings = await privacyService.getPrivacySettings(user.id)
    console.log('✓ Privacy settings:', settings)
  } catch (error) {
    console.error('✗ Failed:', error)
  }

  // Test 2: Export data
  console.log('\n2. Testing exportUserData()...')
  try {
    const exportData = await privacyService.exportUserData(user.id)
    console.log('✓ Export data:', JSON.stringify(exportData, null, 2))
  } catch (error) {
    console.error('✗ Failed:', error)
  }

  // Test 3: Download export
  console.log('\n3. Testing downloadDataExport()...')
  try {
    await privacyService.downloadDataExport(user.id)
    console.log('✓ Download started')
  } catch (error) {
    console.error('✗ Failed:', error)
  }

  console.log('\nAll tests completed!')
}

testPrivacyExport()
```

## Dependencies
- Task 004 (TypeScript types must be defined)

## Conflicts
None

## Testing
```bash
# Run unit tests
npm run test -- privacyService

# Test export functionality
npm run test-privacy-export

# Test with real Supabase
npm run test-privacy-service
```

## Verification
- [ ] Privacy service created with all methods
- [ ] updatePrivacySettings() works correctly
- [ ] getPrivacySettings() retrieves settings
- [ ] exportUserData() exports all data
- [ ] downloadDataExport() triggers download
- [ ] isProfileVisible() returns correct status
- [ ] initializePrivacySettings() sets defaults
- [ ] Export format is valid JSON
- [ ] Export includes timestamp
- [ ] Tests pass

## GDPR/CCPA Compliance
- Right to data portability (export)
- Right to privacy (private by default)
- Right to access (view own data)
- Right to rectification (update settings)
- Audit trail (timestamp on export)

## Security Considerations
- Users can only export their own data (RLS)
- No sensitive data in export (passwords, tokens)
- Export files are client-side only
- No server-side storage of exports
- Consider adding rate limiting for exports

## Notes
- Export format should be machine-readable
- Include schema version in export
- Consider adding export history
- Default to private for all settings
- Document privacy settings clearly
