# Story 1.2: Service Layer Consolidation

*Powered by BMAD™ Core v2.0 | Story Document*

## Status
**Draft** - Ready for implementation approval

## Story
**As a** developer,
**I want** consolidated service patterns,
**so that** I can maintain fewer duplicate implementations while preserving all integrations and API functionality.

## Acceptance Criteria
1. Task services consolidated from multiple implementations to single composable service
2. Data services streamlined while maintaining all current operations
3. Supabase integrations remain fully functional with identical API contracts
4. API error handling patterns preserved with same user experience
5. All existing service method signatures and return types unchanged
6. Build and runtime performance maintained or improved

## Tasks / Subtasks

- [ ] **Task 1: Analyze Current Service Layer Fragmentation** (AC: 1, 2)
  - [ ] Map all existing service implementations across the codebase
  - [ ] Document current task service patterns and their usage locations
  - [ ] Identify duplicate data service operations and their variations
  - [ ] Create service consolidation strategy with compatibility matrix

- [ ] **Task 2: Create Unified Task Service** (AC: 1, 3, 5)
  - [ ] Design single TaskService class consolidating all task operations
  - [ ] Implement composable methods supporting all current use cases
  - [ ] Preserve all existing method signatures for backward compatibility
  - [ ] Maintain Supabase task operations exactly as before
  - [ ] Create comprehensive TypeScript interfaces for service contracts

- [ ] **Task 3: Create Unified Data Service** (AC: 2, 3, 5)
  - [ ] Consolidate data operations into single DataService class
  - [ ] Preserve all Supabase query patterns and database operations
  - [ ] Maintain existing error handling and data transformation logic
  - [ ] Ensure all CRUD operations function identically
  - [ ] Implement same caching and optimization patterns

- [ ] **Task 4: Update Service Integration Points** (AC: 4, 5, 6)
  - [ ] Create Git checkpoint before service replacement
  - [ ] Replace fragmented services with unified implementations
  - [ ] Update all import statements to use new service locations
  - [ ] Verify all components using services work identically
  - [ ] Test error handling maintains same user-facing behavior

## Dev Notes

### Relevant Source Tree Information
Based on architectural analysis, current service fragmentation exists in:
```
src/services/tasks/                        # Multiple task service implementations
  ├── LightWorkDatabaseOperations.ts       # Light work specific operations
  ├── TaskDataTransformer.ts               # Data transformation patterns
  └── [other fragmented implementations]

src/services/                              # Various service patterns
src/ecosystem/internal/*/services/         # Feature-specific services
src/shared/                               # Contains misplaced service logic
```

**Current Issues Identified:**
- 6 different service layer patterns creating maintenance burden
- Duplicate Supabase operations across different service implementations
- Inconsistent error handling patterns across services
- Service logic scattered in shared folders inappropriately

**Integration Points to Preserve:**
- All Supabase database operations must function identically
- Error handling must produce same user-facing messages
- React Query integration patterns must be maintained
- Service method contracts must remain backward compatible

**Consolidation Strategy:**
- `TaskService` - All task-related operations (create, update, delete, queries)
- `DataService` - All generic data operations (Supabase client interactions)
- `AuthService` - Authentication-related service operations (optimized separately)

### Testing Standards
**Test File Location:** 
- `src/services/tasks/__tests__/TaskService.test.ts`
- `src/services/data/__tests__/DataService.test.ts`

**Test Standards:** Vitest with Supabase mocking for service testing
**Testing Frameworks:**
- Vitest for unit testing service methods
- Supabase client mocking for database operation testing
- Error scenario testing for all service operations

**Specific Testing Requirements:**
- Mock all Supabase database calls for isolated service testing
- Test service method signatures remain identical to current implementations
- Verify error handling produces same error messages and structures
- Integration tests with React Query patterns
- Performance regression testing for service operation timing

**Integration Verification Requirements:**
- IV1: All existing API calls continue to function correctly
- IV2: Error handling maintains current user experience
- IV3: Data persistence and retrieval operations remain intact

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation from PRD | Claude + User |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during implementation*

### Debug Log References  
*To be populated during implementation*

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*

---

*Story designed for safe service consolidation while preserving all database operations and API contracts*