#!/usr/bin/env bash
set -euo pipefail

# codex-research: capture a research query bundle for Codex Deep Research Mode

if [[ $# -eq 0 ]]; then
  echo "Usage: $(basename "$0") <research question / topic>" >&2
  echo "Example: $(basename "$0") state of llama.cpp inference performance last 90 days" >&2
  exit 2
fi

timestamp=$(date +%Y%m%d-%H%M%S)
slug=$(printf "%s" "$*" | tr -cd '[:alnum:] _.-' | tr ' ' '-' | cut -c1-40)
slug=${slug:-query}
session_root="SISO-INTERNAL/.codex-research"
run_dir="$session_root/${timestamp}-${slug}"
mkdir -p "$run_dir"

bundle_json="$run_dir/bundle.json"
query_str="$*"

if command -v python3 >/dev/null 2>&1; then
  python3 - "$bundle_json" "$query_str" <<'PY'
import json, os, sys
from pathlib import Path

bundle_json, query = sys.argv[1], sys.argv[2]
bundle = {
    "schema": "codex.research-bundle/v1",
    "query": query,
    "depth": "standard",
    "timeframe_days": 180,
    "constraints": {
        "regions": [],
        "languages": [],
        "must_include_domains": [],
        "exclude_domains": []
    },
    "deliverables": ["executive_summary", "key_findings", "sources", "next_steps"],
    "created_at": os.popen('date -Iseconds').read().strip(),
    "cwd": os.getcwd(),
}
Path(bundle_json).write_text(json.dumps(bundle, indent=2))
print(bundle_json)
PY
else
  printf '{\n  "schema": "codex.research-bundle/v1",\n  "query": %q,\n  "depth": "standard"\n}\n' "$query_str" >"$bundle_json"
  printf '%s\n' "$bundle_json"
fi

ln -sfn "$(basename "$run_dir")" "$session_root/latest"

echo "Research bundle saved:" >&2
echo "  $bundle_json" >&2
echo "Start a Codex session with profile 'deep-research' to begin." >&2

